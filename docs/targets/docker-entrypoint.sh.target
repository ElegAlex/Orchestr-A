#!/bin/sh
# ============================================================================
# ORCHESTR'A API - Docker Entrypoint (Cible Sprint 1)
# ============================================================================
# Ce script s'exécute au démarrage du container API et :
# 1. Attend que PostgreSQL soit accessible
# 2. Exécute les migrations Prisma automatiquement
# 3. Lance l'application NestJS
#
# Emplacement final : apps/api/docker-entrypoint.sh
# ============================================================================

set -e

echo "=================================================================="
echo "  ORCHESTR'A API - Container Starting"
echo "=================================================================="
echo ""

# ========================================
# 1. Attendre PostgreSQL
# ========================================
echo "[1/3] Checking database connectivity..."

# Extraire host et port de DATABASE_URL si disponible
# Format: postgresql://user:pass@host:port/dbname
if [ -n "$DATABASE_URL" ]; then
    DB_HOST=$(echo "$DATABASE_URL" | sed -n 's/.*@\([^:]*\):.*/\1/p')
    DB_PORT=$(echo "$DATABASE_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
else
    DB_HOST="${DB_HOST:-postgres}"
    DB_PORT="${DB_PORT:-5432}"
fi

echo "      Waiting for PostgreSQL at $DB_HOST:$DB_PORT..."

# Attendre que le port soit accessible (max 60 secondes)
COUNTER=0
MAX_TRIES=30
until nc -z "$DB_HOST" "$DB_PORT" 2>/dev/null; do
    COUNTER=$((COUNTER + 1))
    if [ $COUNTER -ge $MAX_TRIES ]; then
        echo "      ERROR: PostgreSQL not reachable after ${MAX_TRIES} attempts"
        exit 1
    fi
    echo "      Attempt $COUNTER/$MAX_TRIES - waiting..."
    sleep 2
done

echo "      PostgreSQL is reachable"
echo ""

# ========================================
# 2. Exécuter les migrations
# ========================================
echo "[2/3] Running database migrations..."

cd /app/packages/database

# Prisma migrate deploy (safe pour production)
# - N'applique que les migrations en attente
# - Ne génère pas de nouvelles migrations
# - Échoue si le schéma est désynchronisé
if npx prisma migrate deploy; then
    echo "      Migrations completed successfully"
else
    echo "      ERROR: Migration failed"
    echo "      Check your DATABASE_URL and migration files"
    exit 1
fi

echo ""

# ========================================
# 3. Démarrer l'application
# ========================================
echo "[3/3] Starting NestJS application..."
echo ""
echo "=================================================================="
echo "  API Ready - Listening on port ${PORT:-4000}"
echo "=================================================================="
echo ""

cd /app
exec node apps/api/dist/src/main.js
